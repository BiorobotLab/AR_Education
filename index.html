<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>BioLab AR Demonstration</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/aframe-text-geometry-component@^0.5.0/dist/aframe-text-geometry-component.min.js"></script>

    <script>
        /** @type {import('aframe')} */
        /* global AFRAME */
        
        // 注册浮动动画组件
        AFRAME.registerComponent('float-animation', {
            init: function() {
                this.originalY = this.el.getAttribute('position').y;
            },
            tick: function(time) {
                if (this.el.getAttribute('visible')) {
                    const newY = this.originalY + Math.sin(time * 0.001) * 0.05;
                    const currentPosition = this.el.getAttribute('position');
                    this.el.setAttribute('position', {
                        x: currentPosition.x,
                        y: newY,
                        z: currentPosition.z
                    });
                }
            }
        });
    </script>

    <style>
        body {
            margin: 0;
        }
        .a-enter-vr {
            display: none !important;
        }
    </style>
</head>

<body>
    <a-scene embedded arjs='trackingMethod: best; sourceType: webcam; debugUIEnabled: true;'
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true">

        <a-marker preset="pattern" type="pattern" id="markerSB" url="./patterns/surgery_bed.patt">
        <!-- <a-marker preset="hiro"> -->


            <a-entity
                id="surgery_bed_Model"
                position="0 0 0"
                scale="0.0002 0.0002 0.0002"
                gltf-model="url(models/surgery_bed.gltf)">
            </a-entity>

            <a-entity
                id="introSB"
                position="0 1.5 0"
                rotation="-90 0 0"
                text="value: This is introduction of surgery bed; 
                      width: 2;
                      color: white;
                      align: center;
                      baseline: center;
                      wrapCount: 20;
                      opacity: 0.9"
                visible="false">
            </a-entity>

            <!-- <a-entity
                position="0 0 0"
                scale="0.05 0.05 0.05"
                gltf-model="https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/scene.gltf"
            ></a-entity> -->

            <a-plane
                id="introSB_background"
                position="0 1.5 -0.01"
                rotation="-90 0 0"
                width="2.2"
                height="1"
                color="#000"
                opacity="0.5"
                visible="false">
            </a-plane>
        </a-marker>



        <a-entity camera></a-entity camera>
    </a-scene>

    <script>

        window.addEventListener('load', function() {
            let introSBVisible = false;
            const modelSB = document.getElementById('surgery_bed_Model');
            const introSB = document.getElementById('introSB');
            const introSB_bg = document.getElementById('introSB_background');
            const markerSB = document.getElementById("markerSB");
            
            function setVisible(visible) {
                introSB.setAttribute('visible', visible);
                introSB_bg.setAttribute('visible', visible);
            }
            
            if (modelSB && introSB && introSB_bg && markerSB) {
                // 监听模型加载完成事件
                modelSB.addEventListener('model-loaded', () => {
                    console.log('Surgery bed model loaded successfully.');
                });

                modelSB.addEventListener('click', function() {
                    introSBVisible = !introSBVisible;
                    setVisible(introSBVisible);
                    console.log('IntroSB visibility toggled:', introSBVisible);
                });

                markerSB.addEventListener('markerFound', () => {
                    console.log('Marker found');
                });

                markerSB.addEventListener('markerLost', () => {
                    console.log('Marker lost');
                    introSBVisible = false;
                    setVisible(introSBVisible);
                });

                introSB_bg.setAttribute('float-animation', '');
            }
        });
        
        document.addEventListener('touchstart', function(e) {
            e.preventDefault();
        }, {passive: false});

        // 自定义组件：模型持久化
        AFRAME.registerComponent('persistent-model', {
            schema: {
                modelUrl: { type: 'string' },
                scale: { type: 'vec3', default: { x: 1, y: 1, z: 1 } }
            },
            init: function() {
                const el = this.el;
                const modelUrl = this.data.modelUrl;
                const scale = this.data.scale;

                // 加载模型
                new THREE.GLTFLoader().load(modelUrl, (gltf) => {
                    this.model = gltf.scene;
                    this.model.scale.set(scale.x, scale.y, scale.z);
                    el.setObject3D('mesh', this.model);

                    // 首次加载时记录位置（模拟标记点初始化）
                    if (!localStorage.getItem('modelMatrix')) {
                        const matrix = new THREE.Matrix4().compose(
                            new THREE.Vector3(0, 0, -1), // 默认位置：摄像头前方1米
                            new THREE.Quaternion(),
                            new THREE.Vector3(1, 1, 1)
                        );
                        localStorage.setItem('modelMatrix', JSON.stringify(matrix.elements));
                    }

                    // 从缓存恢复位置
                    const savedMatrix = JSON.parse(localStorage.getItem('modelMatrix'));
                    this.model.applyMatrix4(new THREE.Matrix4().fromArray(savedMatrix));
                });
            },
            tick: function() {
                // 持续更新模型位置（基于SLAM的相机位移）
                if (this.model) {
                    const camera = document.querySelector('[camera]').object3D;
                    const inverseMatrix = new THREE.Matrix4().copy(camera.matrixWorld).invert();
                    this.model.position.applyMatrix4(inverseMatrix);
                }
            }
        });

        // 自定义组件：SLAM标记替代
        AFRAME.registerComponent('slam-marker', {
            init: function() {
                const sceneEl = this.el.sceneEl;
                sceneEl.addEventListener('arjs-video-loaded', () => {
                    console.log('SLAM环境已初始化');
                });
            }
        });
    </script>
</body>
</html>