<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>BioLab AR Demonstration</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/aframe-text-geometry-component@^0.5.0/dist/aframe-text-geometry-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>

    <style>
        body {
            margin: 0;
        }
        .a-enter-vr {
            display: none !important;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        #loading-message {
            margin-top: 20px;
            font-size: 1.2em;
        }
        #loading-progress {
            width: 50%;
            max-width: 300px;
            height: 10px;
            background: #333;
            margin-top: 20px;
            border-radius: 5px;
            overflow: hidden;
        }
        #loading-progress-bar {
            height: 100%;
            width: 0%;
            background: #4CAF50;
            transition: width 0.3s ease;
        }
    </style>
</head>

<body>
    <a-scene embedded
        arjs='trackingMethod: best; sourceType: webcam; sourceWidth: 1920;
        sourceHeight: 1080; frameRate: 60; displayWidth: window.innerWidth;
        displayHeight: window.innerHeight; detectionMode: mono898; matrixCodeType: 3x3;'
        vr-mode-ui="enabled: false">

        <!--        Arm        -->
        <a-entity
            id="Arm"
            position="0 0 0"
            rotation="0 0 0"
            scale="0.025 0.025 0.025"
            gltf-model="url(models/arm.gltf)"
            visible="false">
        </a-entity>

        <!--      console      -->
        <a-entity
            id="Console"
            position="0 0 0"
            rotation="0 0 0"
            scale="0.025 0.025 0.025"
            gltf-model="url(models/console.gltf)"
            visible="false">
        </a-entity>

        <!--      vision      -->
        <a-entity
            id="Vision"
            position="0 0 0"
            rotation="0 0 0"
            scale="0.025 0.025 0.025"
            gltf-model="url(models/vision.gltf)"
            visible="false">
        </a-entity>


        <script id="marker-template" type="text/html">
            <a-marker preset="pattern" type="pattern" id="{{device}}{{dir}}"
                url="./patterns/{{patternFile}}.patt"
                size="0.1">
            </a-marker>
        </script>
     
        <a-entity camera></a-entity camera>
    </a-scene>


    <script>
        const scene = document.querySelector('a-scene');    
        scene.addEventListener('loaded', function() {

            const devices = ["Arm", "Console", "Vision"];
            const directions = ["Front", "Left", "Right", "Back"];
            const offsets = {
                Front: [0, 1],
                Left: [-1, 0],
                Right: [1, 0],
                Back: [0, -1],
            }

            const template = document.getElementById('marker-template').innerHTML;

            const deviceState = {};
            devices.forEach(device => {
                deviceState[device] = {
                    currentMarker: null,
                    hideTimeout: null
                };

                directions.forEach(dir => {
                    let html = template
                        .replace(/{{device}}/g, device)
                        .replace(/{{dir}}/g, dir)
                        .replace(/{{patternFile}}/g, `${device.toLocaleLowerCase()}${dir}`);

                    const div = document.createElement('div');
                    div.innerHTML = html;
                    scene.append(...div.childNodes);
                });
            });

            devices.forEach(device => {
                directions.forEach(dir => {
                    const markerId = `${device}${dir}`;
                    const markerEl = document.querySelector(`#${markerId}`);
                    const modelEl = document.getElementById(device);

                    if (!markerEl || !modelEl) {
                        console.error(`Missing element for ${markerId}`);
                        return;
                    }

                    markerEl.markerData = {
                        device: device,
                        dir: dir,
                        offset: offsets[dir]
                    }

                    markerEl.addEventListener('markerFound', () => {
                        console.log(`${markerId} found`);

                        const state = deviceState[device];

                        // No current Marker -> hideTimeout; 
                        if (state.hideTimeout) {
                            clearTimeout(state.hideTimeout);
                            state.hideTimeout = null;
                        }

                        if(!state.currentMarker) state.currentMarker = markerEl;

                        updateDeviceModel(device);
                    });

                    markerEl.addEventListener('markerLost', () => {
                        const state = deviceState[device];

                        if (state.currentMarker === markerEl) {
                            console.log(`${markerId} lost`);
                            state.hideTimeout = setTimeout(() => {
                                modelEl.setAttribute('visible', false);
                                state.currentMarker = null;
                            }, 2000);
                        }
                    });
                });
            });
            
            function updateDeviceModel(device) {
                const state = deviceState[device];
                const modelEl = document.getElementById(device);

                if (!state.currentMarker || !modelEl) return;

                const markerEl = state.currentMarker;
                const offset = markerEl.markerData.offset;

                const worldPos = new THREE.Vector3();
                markerEl.object3D.getWorldPosition(worldPos);
                

                modelEl.object3D.position.set(
                    worldPos.x + offset[0],
                    worldPos.y + offset[1],
                    worldPos.z,
                );

                modelEl.object3D.rotation.copy(markerEl.object3D.rotation);
                modelEl.setAttribute('visible', true);
            }


            function update() {
                devices.forEach(device => {
                    const state = deviceState[device];
                    if (state.currentMarker) {
                        updateDeviceModel(device);
                    }
                });

                requestAnimationFrame(update);
            }
            
            update();
        });
    </script>
</body>

</html>
